<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>살살하루 절운동 카운터 + 달력 기록</title>
  <style>
    :root {
      --bg:#0f1220; --card:#171a2b; --text:#e9ecff; --muted:#9aa3c7; --accent:#82a0ff;
      --btn:#22263c; --btn2:#2b3150; --good:#68d391; --warn:#f6ad55; --danger:#f56565;
      --ring:#2b3150; --grid:#212744;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, "Apple SD Gothic Neo", "Noto Sans KR", sans-serif;
      background: radial-gradient(1200px 700px at 30% -10%, #1b2040, transparent), var(--bg);
      color: var(--text);
    }
    .container { max-width: 980px; margin: 0 auto; padding: 20px 16px 64px; }
    h1 { margin: 4px 0 16px; font-size: clamp(22px, 4vw, 28px); font-weight: 800; letter-spacing: .3px; }
    .sub { color: var(--muted); font-size: 13px; }
    .wrap { display: grid; gap: 14px; grid-template-columns: 1fr; }
    @media (min-width: 980px){ .wrap { grid-template-columns: 520px 1fr; align-items: start; } }
    .card {
      background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.0));
      border: 1px solid rgba(255,255,255,.06); border-radius: 16px; padding: 14px;
      box-shadow: 0 10px 24px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.03);
    }
    .row { display: grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap: 10px; }
    @media (min-width: 680px){ .row { grid-template-columns: repeat(4, minmax(0,1fr)); } }
    label { display: flex; flex-direction: column; gap: 6px; font-size: 13px; color: var(--muted); }
    input[type="number"], select {
      width: 100%; padding: 11px 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,.08);
      background: var(--card); color: var(--text); outline: none; font-size: 16px;
    }
    input[type="checkbox"] { transform: translateY(2px); }
    .inline { display:flex; align-items:center; gap:10px; flex-wrap: wrap; }
    .muted { color: var(--muted); font-size: 13px; }
    .counter {
      display: flex; align-items: baseline; gap: 12px; justify-content: center; padding: 8px 0 0;
      font-weight: 800; letter-spacing: .5px;
    }
    .counter .num { font-size: clamp(56px, 14vw, 90px); line-height: 1; }
    .counter .goal { font-size: clamp(18px, 3.5vw, 22px); color: var(--muted); }
    .subgrid { display: grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap: 12px; margin-top: 8px; }
    .pill {
      border: 1px dashed rgba(255,255,255,.15); padding: 10px 12px; border-radius: 12px; text-align: center;
      font-variant-numeric: tabular-nums; font-size: 15px; color: var(--muted);
    }
    .btns { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-top: 10px; }
    button {
      appearance: none; border: 1px solid rgba(255,255,255,.08); border-radius: 12px; padding: 11px 14px;
      background: var(--btn); color: var(--text); font-weight: 700; font-size: 16px; cursor: pointer;
      transition: transform .05s ease, background .2s ease, border-color .2s ease;
    }
    button:hover { border-color: rgba(255,255,255,.18); }
    button:active { transform: translateY(1px) scale(.99); }
    .primary { background: var(--btn2); }
    .good { background: rgba(104,211,145,.12); border-color: rgba(104,211,145,.35); }
    .warn { background: rgba(246,173,85,.12); border-color: rgba(246,173,85,.35); }
    .danger { background: rgba(245,101,101,.12); border-color: rgba(245,101,101,.35); }

    .hide { display: none !important; }
    footer { margin-top: 16px; text-align: center; color: var(--muted); font-size: 12px; }

    /* Calendar */
    .cal-head { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
    .cal-head h2 { margin:0; font-size:18px; }
    .cal-grid { display:grid; grid-template-columns: repeat(7, 1fr); gap: 6px; }
    .cal-cell { border:1px solid rgba(255,255,255,.06); background: rgba(255,255,255,.02); border-radius:12px; padding:8px; min-height:88px; position:relative; }
    .cal-cell .day { font-size:13px; color:var(--muted); }
    .cal-cell .sum { position:absolute; bottom:8px; left:8px; right:8px; display:flex; justify-content:space-between; font-size:12px; color:var(--muted); }
    .cal-cell.today { outline:1px solid var(--accent); }
    .cal-cell .badge { position:absolute; top:8px; right:8px; background: rgba(130,160,255,.16); color:#dbe3ff; padding:2px 6px; border-radius:999px; font-size:11px; }
    .dow { text-align:center; font-size:12px; color:var(--muted); margin: 6px 0; }

    .session-list { max-height: 280px; overflow:auto; border-top:1px dashed rgba(255,255,255,.1); margin-top:10px; padding-top:8px; }
    .sess { display:grid; grid-template-columns: 1fr auto; gap: 10px; align-items:center; padding:8px; border:1px dashed rgba(255,255,255,.12); border-radius:10px; margin-bottom:8px; }
    .sess .meta { font-size:13px; color:var(--muted); }
    .sess .title { font-weight:700; }
    .sess .note { width:100%; padding:8px; border-radius:8px; border:1px solid rgba(255,255,255,.12); background:#12162b; color:var(--text); }
    .grid-two { display:grid; grid-template-columns: repeat(2,minmax(0,1fr)); gap:8px; }

    .table-wrap { overflow:auto; }
    table { width:100%; border-collapse: collapse; }
    th, td { border-bottom:1px solid rgba(255,255,255,.06); padding:10px 8px; font-size:14px; }
    th { color:#c9d2ff; text-align:left }
  </style>

  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#F7F0E3">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
</head>
<body>
  <div class="container">
    <h1>살살하루 절운동 카운터 <span class="sub">수동/자동 + 달력 기록</span></h1>
    <div class="wrap">
      <!-- Left: Counter -->
      <div class="card">
        <div class="row">
          <label>모드
            <select id="mode">
              <option value="timed">자동(초/1회)</option>
              <option value="manual">수동</option>
            </select>
          </label>
          <label>목표 횟수
            <input type="number" id="goal" value="100" min="1" step="1" />
          </label>
          <label id="timedBox">1회 시간(초)
            <input type="number" id="secPerRep" value="9" min="1" step="0.1" />
          </label>
          <label>옵션
            <div class="inline">
              <label class="inline"><input type="checkbox" id="sound" checked /> 소리</label>
              <label class="inline"><input type="checkbox" id="vibe" checked /> 진동</label>
            </div>
          </label>
        </div>
        <div class="muted" style="margin-top:8px">
          💡 자동 모드: 시작과 함께 타이머가 돌고, 설정한 초마다 자동으로 +1. 일시정지/재개 가능.
        </div>

        <div class="counter">
          <div class="num" id="count">0</div>
          <div class="goal">/ <span id="goalOut">100</span></div>
        </div>

        <div id="timedOnly" class="subgrid">
          <div class="pill">이번 1회 남은 시간: <b id="remain">-</b>s</div>
          <div class="pill">세션 경과: <b id="elapsed">00:00</b></div>
        </div>

        <div id="manualOnly" class="btns hide">
          <button id="plus" class="primary">+1</button>
          <button id="minus">-1</button>
        </div>

        <div class="btns">
          <button id="start" class="good">세션 시작</button>
          <button id="pause" class="warn" disabled>일시정지</button>
          <button id="save" class="primary" disabled>세션 저장</button>
          <button id="reset" class="danger">리셋</button>
        </div>

        <div class="muted" style="margin-top:6px">
          단축키: 자동모드 <b>Space</b>=시작/일시정지, <b>R</b>=리셋 · 수동모드 <b>Space/Enter</b>=+1, <b>Backspace</b>=-1
        </div>
      </div>

      <!-- Right: Calendar & Logs -->
      <div class="card">
        <div class="cal-head">
          <button id="prevMon">◀</button>
          <h2 id="monTitle">2025-08</h2>
          <button id="nextMon">▶</button>
        </div>
        <div class="cal-grid dow">
          <div>일</div><div>월</div><div>화</div><div>수</div><div>목</div><div>금</div><div>토</div>
        </div>
        <div id="cal" class="cal-grid" style="margin-top:6px"></div>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-top:10px;">
          <div class="muted">선택한 날짜의 세션 목록</div>
          <div class="inline">
            <button id="export" class="primary">CSV 내보내기</button>
            <button id="clearAll" class="danger">전체 삭제</button>
          </div>
        </div>

        <div id="daySummary" class="muted" style="margin-top:6px"></div>
        <div id="sessions" class="session-list"></div>
      </div>
    </div>

    <footer>로컬 저장(브라우저) · 홈 화면 추가 추천 · 만든 사람: 살살하루 @Salsal Day </footer>
  </div>

  <script>
    // ---------- Elements
    const E = (id)=>document.getElementById(id);
    const els = {
      mode: E('mode'),
      goal: E('goal'),
      goalOut: E('goalOut'),
      secPerRep: E('secPerRep'),
      sound: E('sound'),
      vibe: E('vibe'),
      count: E('count'),
      remain: E('remain'),
      elapsed: E('elapsed'),
      timedOnly: E('timedOnly'),
      manualOnly: E('manualOnly'),
      timedBox: E('timedBox'),
      start: E('start'),
      pause: E('pause'),
      save: E('save'),
      reset: E('reset'),
      plus: E('plus'),
      minus: E('minus'),
      cal: E('cal'),
      monTitle: E('monTitle'),
      prevMon: E('prevMon'),
      nextMon: E('nextMon'),
      sessions: E('sessions'),
      daySummary: E('daySummary'),
      exportBtn: E('export'),
      clearAll: E('clearAll'),
    };

    // ---------- State
    const LS_LOGS_V2 = 'jeol.logs.v2';     // [{id, startAt, endAt, count, durationMs, mode, perRepSec, note}]
    const LS_PREFS   = 'jeol.prefs.v1';    // {mode, goal, perRepSec, sound, vibe}
    const v1Key = 'jeol.logs.v1';          // migration

    let logs = [];
    let prefs = {
      mode: localStorage.getItem('mode') || 'timed',
      goal: parseInt(localStorage.getItem('goal') || '100', 10),
      perRepSec: parseFloat(localStorage.getItem('perRepSec') || '9'),
      sound: true, vibe: true,
    };
    // Load newer prefs if exist
    try{
      const pp = JSON.parse(localStorage.getItem(LS_PREFS) || '{}');
      Object.assign(prefs, pp);
    }catch{}

    let state = {
      mode: prefs.mode || 'timed',
      count: 0,
      goal: prefs.goal || 100,
      perRepMs: Math.max(1000, Math.floor((prefs.perRepSec || 9) * 1000)),
      running: false,
      paused: false,
      nextTick: null,
      sessionStart: null,
      pauseRemainMs: 0,
      elapsedAtPause: 0,

      // calendar
      curYear: (new Date()).getFullYear(),
      curMon: (new Date()).getMonth(), // 0-based
      selectedDateKey: ymd(new Date()),
    };

    let rafId = null;
    let audioCtx = null;
    let wakeLock = null;

    // ---------- Utils
    function ymd(d){
      const dt = new Date(d);
      const y = dt.getFullYear();
      const m = String(dt.getMonth()+1).padStart(2,'0');
      const da = String(dt.getDate()).padStart(2,'0');
      return `${y}-${m}-${da}`;
    }
    function fmtMMSS(ms) {
      ms = Math.max(0, ms|0);
      const s = Math.floor(ms/1000);
      const mm = String(Math.floor(s/60)).padStart(2,'0');
      const ss = String(s%60).padStart(2,'0');
      return mm + ':' + ss;
    }
    function fmtSec1(ms) { return (Math.max(0, ms)/1000).toFixed(1); }

    function beep() {
      if (!els.sound.checked) return;
      try {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        o.type = 'sine';
        o.frequency.value = 880;
        o.connect(g); g.connect(audioCtx.destination);
        const t = audioCtx.currentTime;
        g.gain.setValueAtTime(0.0001, t);
        g.gain.exponentialRampToValueAtTime(0.35, t + 0.02);
        g.gain.exponentialRampToValueAtTime(0.0001, t + 0.14);
        o.start(t); o.stop(t + 0.16);
      } catch (e) {}
    }
    function vibrate(ms=40) {
      if (!els.vibe.checked) return;
      if (navigator.vibrate) { try { navigator.vibrate(ms); } catch(e){} }
    }

    async function requestWakeLock() {
      try {
        if ('wakeLock' in navigator) {
          wakeLock = await navigator.wakeLock.request('screen');
          wakeLock.addEventListener('release', ()=>{});
        }
      } catch(e){}
    }
    async function releaseWakeLock() {
      try { if (wakeLock) { await wakeLock.release(); wakeLock = null; } } catch(e){}
    }

    // ---------- Persistence
    function loadLogs(){
      // migrate v1 if present
      const v1 = localStorage.getItem(v1Key);
      if (v1){
        try {
          const arr = JSON.parse(v1);
          if (Array.isArray(arr) && arr.length){
            // map to v2
            logs = arr.map((it, idx)=> ({
              id: 'm'+idx+'_'+(it.startAt || Date.now()),
              startAt: it.startAt || new Date().toISOString(),
              endAt: it.endAt || it.startAt || new Date().toISOString(),
              count: it.count || 0,
              durationMs: it.durationMs || 0,
              mode: 'manual',
              perRepSec: null,
              note: it.note || ''
            }));
            saveLogs();
          }
          localStorage.removeItem(v1Key);
        }catch{}
      } else {
        try { logs = JSON.parse(localStorage.getItem(LS_LOGS_V2) || '[]'); if (!Array.isArray(logs)) logs = []; } catch { logs = []; }
      }
    }
    function saveLogs(){ localStorage.setItem(LS_LOGS_V2, JSON.stringify(logs)); }
    function savePrefs(){
      localStorage.setItem(LS_PREFS, JSON.stringify({
        mode: state.mode,
        goal: state.goal,
        perRepSec: state.perRepMs / 1000,
        sound: els.sound.checked,
        vibe: els.vibe.checked,
      }));
      // also keep old keys for backward compat with previous file
      localStorage.setItem('mode', state.mode);
      localStorage.setItem('goal', String(state.goal));
      localStorage.setItem('perRepSec', String(state.perRepMs/1000));
    }

    // ---------- Rendering
    function refreshModeUI(){
      els.goal.value = state.goal;
      els.goalOut.textContent = state.goal;
      els.secPerRep.value = (state.perRepMs/1000);
      els.mode.value = state.mode;
      const isTimed = state.mode === 'timed';
      els.timedOnly.classList.toggle('hide', !isTimed);
      els.manualOnly.classList.toggle('hide', isTimed);
      els.timedBox.classList.toggle('hide', !isTimed);
      // buttons
      els.start.disabled = false;
      els.pause.disabled = true;
      els.save.disabled = true;
    }
    function renderCounts(){ els.count.textContent = state.count; els.goalOut.textContent = state.goal; }
    function renderTimers(nowMs){
      if (state.mode !== 'timed'){ els.remain.textContent = '-'; els.elapsed.textContent = state.running ? fmtMMSS(Date.now()-state.sessionStart) : '00:00'; return; }
      if (!state.running){ els.remain.textContent = '-'; els.elapsed.textContent = '00:00'; return; }
      if (state.paused){ els.remain.textContent = fmtSec1(state.pauseRemainMs); els.elapsed.textContent = fmtMMSS(state.elapsedAtPause); }
      else { const remainMs = Math.max(0, state.nextTick - nowMs); els.remain.textContent = fmtSec1(remainMs); const elapsed = nowMs - state.sessionStart; els.elapsed.textContent = fmtMMSS(elapsed); }
    }

    function renderCalendar(){
      const y = state.curYear, m = state.curMon; // 0-based
      els.monTitle.textContent = y + '-' + String(m+1).padStart(2,'0');
      const first = new Date(y, m, 1);
      const startDay = first.getDay(); // 0=Sun
      const lastDate = new Date(y, m+1, 0).getDate();

      // aggregate logs by date
      const agg = {};
      for (const it of logs){
        const key = ymd(it.startAt);
        if (!agg[key]) agg[key] = { reps:0, dur:0, count:0 };
        agg[key].reps += (it.count||0);
        agg[key].dur += (it.durationMs||0);
        agg[key].count += 1;
      }

      els.cal.innerHTML = '';
      // empty cells before 1st
      for(let i=0;i<startDay;i++){ const d=document.createElement('div'); d.className='cal-cell'; els.cal.appendChild(d); }
      // days
      for(let day=1; day<=lastDate; day++){
        const cell = document.createElement('div');
        const d = new Date(y, m, day);
        const key = ymd(d);
        cell.className = 'cal-cell';
        const todayKey = ymd(new Date());
        if (key === todayKey) cell.classList.add('today');
        cell.innerHTML = `<div class="day">${day}</div>`;
        const sums = agg[key];
        if (sums){
          const rep = sums.reps;
          const dur = fmtMMSS(sums.dur);
          const sessions = sums.count;
          const badge = document.createElement('div');
          badge.className = 'badge';
          badge.textContent = sessions+'회';
          cell.appendChild(badge);
          const sum = document.createElement('div');
          sum.className = 'sum';
          sum.innerHTML = `<span>횟수 ${rep}</span><span>${dur}</span>`;
          cell.appendChild(sum);
        }
        cell.addEventListener('click', ()=>{ state.selectedDateKey = key; renderDaySessions(); });
        els.cal.appendChild(cell);
      }
      renderDaySessions();
    }

    function renderDaySessions(){
      const key = state.selectedDateKey || ymd(new Date());
      const list = logs.filter(it => ymd(it.startAt) === key);
      els.daySummary.textContent = key + ' · 세션 ' + list.length + '개';
      els.sessions.innerHTML = '';
      if (!list.length){ els.sessions.innerHTML = '<div class="muted">아직 기록이 없어요.</div>'; return; }
      for (const [idx, it] of list.entries()){
        const div = document.createElement('div');
        div.className = 'sess';
        const start = new Date(it.startAt);
        const end = new Date(it.endAt);
        const title = `${start.toLocaleTimeString('ko-KR',{hour:'2-digit',minute:'2-digit'})}–${end.toLocaleTimeString('ko-KR',{hour:'2-digit',minute:'2-digit'})} · ${it.count}회 · ${fmtMMSS(it.durationMs||0)}`;
        const meta = `${it.mode==='timed' ? '자동' : '수동'}${it.perRepSec?`·${it.perRepSec}s`:''}`;
        div.innerHTML = `
          <div>
            <div class="title">${title}</div>
            <div class="meta">${meta}</div>
            <div class="grid-two" style="margin-top:6px">
              <input class="note" data-id="${it.id}" value="${(it.note||'').replace(/"/g,'&quot;')}" placeholder="메모" />
              <div class="inline" style="justify-content:flex-end">
                <button class="warn" data-edit="${it.id}">수정</button>
                <button class="danger" data-del="${it.id}">삭제</button>
              </div>
            </div>
          </div>
        `;
        els.sessions.appendChild(div);
      }
      // events
      els.sessions.querySelectorAll('[data-del]').forEach(btn=>{
        btn.addEventListener('click', e=>{
          const id = e.target.getAttribute('data-del');
          const idx = logs.findIndex(x=>x.id===id);
          if (idx>=0 && confirm('이 세션을 삭제할까요?')) { logs.splice(idx,1); saveLogs(); renderCalendar(); }
        });
      });
      els.sessions.querySelectorAll('[data-edit]').forEach(btn=>{
        btn.addEventListener('click', e=>{
          const id = e.target.getAttribute('data-edit');
          const inp = els.sessions.querySelector(`input[data-id="${id}"]`);
          const log = logs.find(x=>x.id===id);
          if (log && inp){ log.note = inp.value; saveLogs(); alert('메모 저장 완료!'); }
        });
      });
    }

    // ---------- Counter core
    function addCount(n=1){
      state.count = Math.max(0, state.count + n);
      renderCounts();
      if (n>0){ beep(); vibrate(35); }
      if (state.goal && state.count >= state.goal && state.running){
        // 자동 정지 X, 사용자가 저장하도록
      }
    }

    function loop(now){
      rafId = requestAnimationFrame(loop);
      const nowMs = Date.now();
      if (state.mode === 'timed' && state.running && !state.paused){
        while (nowMs >= state.nextTick) {
          addCount(1);
          state.nextTick += state.perRepMs;
        }
      }
      renderTimers(nowMs);
    }

    function startSession(){
      if (state.running) return;
      state.running = true;
      state.paused = false;
      state.sessionStart = Date.now();
      state.nextTick = Date.now() + (state.mode==='timed' ? state.perRepMs : 1e9);
      els.start.disabled = true;
      els.pause.disabled = false;
      els.save.disabled = false;
      requestWakeLock();
      if (!rafId) rafId = requestAnimationFrame(loop);
    }
    function pauseSession(){
      if (!state.running || state.paused) return;
      state.paused = true;
      state.pauseRemainMs = Math.max(0, state.nextTick - Date.now());
      state.elapsedAtPause = Date.now() - state.sessionStart;
      els.pause.textContent = '재개';
    }
    function resumeSession(){
      if (!state.running || !state.paused) return;
      state.paused = false;
      state.sessionStart = Date.now() - state.elapsedAtPause;
      state.nextTick = Date.now() + (state.mode==='timed' ? state.pauseRemainMs : 1e9);
      els.pause.textContent = '일시정지';
    }
    function stopSession(save=false){
      if (!state.running) return;
      const endAt = Date.now();
      const duration = (state.paused ? state.elapsedAtPause : (endAt - state.sessionStart));
      releaseWakeLock();
      els.start.disabled = false;
      els.pause.disabled = true;
      els.save.disabled = true;
      els.pause.textContent = '일시정지';
      state.running = false;
      state.paused = false;

      if (save){
        const entry = {
          id: 'id_'+endAt+'_'+Math.random().toString(36).slice(2,7),
          startAt: new Date(state.sessionStart).toISOString(),
          endAt: new Date(endAt).toISOString(),
          count: state.count,
          durationMs: duration,
          mode: state.mode,
          perRepSec: state.mode==='timed' ? (state.perRepMs/1000) : null,
          note: ''
        };
        logs.unshift(entry);
        saveLogs();
        renderCalendar();
      }
    }
    function resetAll(){
      stopSession(false);
      state.count = 0;
      state.sessionStart = null;
      state.nextTick = null;
      state.pauseRemainMs = 0;
      state.elapsedAtPause = 0;
      renderCounts();
      renderTimers(Date.now());
    }

    // ---------- CSV
    function exportCSV(){
      if (!logs.length){ alert('내보낼 기록이 없어요.'); return; }
      const header = ['date','start','end','count','duration_sec','mode','per_rep_sec','note'];
      const rows = logs.map(it=>{
        const s = new Date(it.startAt); const e = new Date(it.endAt);
        const date = s.toLocaleDateString('ko-KR');
        const start = s.toLocaleString('ko-KR');
        const end = e.toLocaleString('ko-KR');
        const durSec = Math.round((it.durationMs||0)/1000);
        return [date,start,end,it.count,durSec, it.mode, it.perRepSec ?? '', (it.note||'').replaceAll('"','""')];
      });
      const csv = [header.join(','), ...rows.map(r=>r.map(v=>`"${String(v)}"`).join(','))].join('\\n');
      const blob = new Blob(["\\ufeff"+csv], {type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `jeol-calendar-logs-${new Date().toISOString().slice(0,10)}.csv`;
      a.click();
      URL.revokeObjectURL(a.href);
    }

    // ---------- Events
    els.mode.addEventListener('change', ()=>{ state.mode = els.mode.value; savePrefs(); refreshModeUI(); });
    els.goal.addEventListener('change', ()=>{ const v=parseInt(els.goal.value,10); if(!isNaN(v)&&v>0){ state.goal=v; renderCounts(); savePrefs(); } });
    els.secPerRep.addEventListener('change', ()=>{ let v=parseFloat(els.secPerRep.value); if(!isNaN(v)&&v>=1){ state.perRepMs=Math.floor(v*1000); savePrefs(); if(state.running && state.mode==='timed'&&!state.paused){ state.nextTick = Date.now()+state.perRepMs; } }});
    els.start.addEventListener('click', startSession);
    els.pause.addEventListener('click', ()=>{ if(!state.running) return; if(state.paused) resumeSession(); else pauseSession(); });
    els.save.addEventListener('click', ()=> stopSession(true));
    els.reset.addEventListener('click', resetAll);
    els.plus && els.plus.addEventListener('click', ()=> addCount(1));
    els.minus && els.minus.addEventListener('click', ()=> addCount(-1));

    window.addEventListener('keydown', (e)=>{
      if (state.mode==='manual'){
        if (e.key===' ' || e.key==='Enter'){ e.preventDefault(); addCount(1); }
        if (e.key==='Backspace'){ e.preventDefault(); addCount(-1); }
      } else {
        if (e.key===' '){ e.preventDefault(); if(!state.running) startSession(); else if(state.paused) resumeSession(); else pauseSession(); }
        if (e.key.toLowerCase()==='r'){ e.preventDefault(); resetAll(); }
      }
    });

    els.prevMon.addEventListener('click', ()=>{ const d=new Date(state.curYear,state.curMon-1,1); state.curYear=d.getFullYear(); state.curMon=d.getMonth(); renderCalendar(); });
    els.nextMon.addEventListener('click', ()=>{ const d=new Date(state.curYear,state.curMon+1,1); state.curYear=d.getFullYear(); state.curMon=d.getMonth(); renderCalendar(); });

    els.exportBtn.addEventListener('click', exportCSV);
    els.clearAll.addEventListener('click', ()=>{
      if (!logs.length) { alert('삭제할 기록이 없어요.'); return; }
      if (confirm('모든 기록을 삭제할까요? 되돌릴 수 없어요.')){ logs = []; saveLogs(); renderCalendar(); }
    });

    // ---------- Init
    (function init(){
      // load logs
      loadLogs();
      // prefs
      els.sound.checked = prefs.sound !== false;
      els.vibe.checked = prefs.vibe !== false;
      state.mode = prefs.mode || 'timed';
      state.goal = prefs.goal || 100;
      state.perRepMs = Math.max(1000, Math.floor((prefs.perRepSec || 9) * 1000));
      refreshModeUI();
      renderCounts();
      renderTimers(Date.now());
      renderCalendar();
      rafId = requestAnimationFrame(loop);
    })();
  </script>
<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', function() {
      navigator.serviceWorker.register('sw.js').catch(console.error);
    });
  }
</script>
  <script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.getRegistration().then(r => r && r.update());
  navigator.serviceWorker.addEventListener('controllerchange', () => location.reload());
}
</script>
</body>
</html>
